<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - src/define.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>src/define.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">68.21</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">599</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">53.99</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">3.18</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/*#ifndef(UMD)*/
&quot;use strict&quot;;
/*global _GPF_HOST_WSCRIPT*/ // gpf.HOST_WSCRIPT
/*global _gpfAssert*/ // Assertion method
/*global _gpfAsserts*/ // Multiple assertion method
/*global _gpfAttributesAdd*/ // Shortcut for gpf.attributes.add
/*global _gpfContext*/ // Resolve contextual string
/*global _gpfEmptyFunc*/ // An empty function
/*global _gpfErrorDeclare*/ // Declare new gpf.Error names
/*global _GpfFunctionBuilder*/ // Function builder
/*global _gpfHost*/ // Host type
/*global _gpfIdentifierOtherChars*/ // allowed other chars in an identifier
/*global _gpfIgnore*/ // Helper to remove unused parameter warning
/*global _gpfObjectForEach*/ // Similar to [].forEach but for objects
/*exported _GpfClassDefinition*/
/*exported _gpfDecodeAttributeMember*/
/*exported _gpfDefine*/
/*exported _gpfEncodeAttributeMember*/
/*exported _gpfGenDefHandler*/
/*exported _gpfGetClassDefinition*/
// /*#endif*/

_gpfErrorDeclare(&quot;define&quot;, {
    &quot;classMemberOverloadWithTypeChange&quot;:
        &quot;You can&#039;t overload a member and change its type&quot;,
    &quot;classInvalidVisibility&quot;:
        &quot;Invalid visibility keyword&quot;
});

//region Helpers shared with attributes.js

function _gpfEncodeAttributeMember (member) {
    if (&quot;constructor&quot; === member) {
        return &quot;constructor &quot;;
    }
    return member;
}

function _gpfDecodeAttributeMember (member) {
    if (&quot;constructor &quot; === member) {
        return &quot;constructor&quot;;
    }
    return member;
}

//endregion

//region Class constructor

var
    // Critical section to prevent constructor call when creating inheritance relationship
    _gpfClassConstructorAllowed = true;

/**
 * Template for new class constructor
 * - Uses closure to keep track of the class definition
 * - Class name will be injected at the right place
 *
 * @param {_GpfClassDefinition} classDef
 * @return {Function}
 * @closure
 */
function _gpfNewClassConstructorTpl (classDef) {
    return function () {
        if (classDef.isConstructionAllowed()) {
            classDef._resolvedConstructor.apply(this, arguments); //eslint-disable-line no-invalid-this
        }
    };
}

//endregion

//region _super method

/**
 * Detects if the method calls the _super method.
 * The method source is split on the &quot;._super&quot; key and it check first char after to see if it is not an identifier
 * character (meaning it is more than just _super).
 *
 * @param {Function} method
 * @return {Boolean}
 */
function _gpfUsesSuper (method) {
    var parts = method.toString().split(&quot;._super&quot;);
    return !parts.every(function (part) {/*gpf:inline(array)*/
        return -1 !== _gpfIdentifierOtherChars.indexOf(part.charAt(0));
    });
}

/**
 * Generates a closure in which this._super points to the base method of the overridden member
 *
 * @param {Function} superMethod
 * @param {Function} method
 * @return {Function}
 * @closure
 */
function _gpfGenSuperMember (superMethod, method) {
    return function GpfSuperableMethod () {
        var previousSuper = this._super,
            result;
        // Add a new ._super() method pointing to the base class member
        this._super = superMethod;
        try {
            // Execute the method
            result = method.apply(this, arguments);
        } finally {
            // Remove it after execution
            /* istanbul ignore else */ // I don&#039;t expect to define a member named _super to avoid confusion
            if (undefined === previousSuper) {
                delete this._super;
            } else {
                this._super = previousSuper;
            }
        }
        return result;
    };
}

//endregion

//region Class definition

var
    // Global dictionary of known class definitions
    _gpfClassDefinitions = {},

    // Unique class definition ID
    _gpfClassDefUID = 0,

    // Tag to associate class definition to class
    _GPF_CLASSDEF_MARKER = &quot;_gpf_&quot; + gpf.bin.toHexa(gpf.bin.random(), 8);

/**
 * An helper to create class and store its information
 *
 * @param {String|Function} name
 * @param {Function} Super
 * @param {Object} definition
 * @class gpf.ClassDefinition
 * @constructor
 */
function _GpfClassDefinition (name, Super, definition) {
    /*jshint validthis:true*/ // constructor
    this._uid = ++_gpfClassDefUID;
    _gpfClassDefinitions[this._uid] = this;
    this._Subs = [];
    if (&quot;function&quot; === typeof name) {
        this._name = name.compatibleName() || &quot;anonymous&quot;;
        // TODO how do we grab the parent constructor (?)
        this._Constructor = name;
    } else {
        this._name = name;
        this._Super = Super;
        this._definition = definition;
        this._build();
    }
}

/**
 * Retrieves (or allocate) the class definition object
 *
 * @param {Function} constructor Class constructor
 * @return {gpf.ClassDefinition}
 */
function _gpfGetClassDefinition (constructor) {
    var classDef,
        uid = constructor[_GPF_CLASSDEF_MARKER];
    if (undefined === uid) {
        classDef = new _GpfClassDefinition(constructor);
        /*gpf:constant*/ constructor[_GPF_CLASSDEF_MARKER] = classDef._uid;
    } else {
        classDef = _gpfClassDefinitions[uid];
    }
    return classDef;
}

var _gpfVisibilityKeywords      = &quot;public|protected|private|static&quot;.split(&quot;|&quot;),
    _GPF_VISIBILITY_UNKNOWN     = -1,
    _GPF_VISIBILITY_PUBLIC      = 0,
    _GPF_VISIBILITY_PROTECTED   = 1,
//  _GPF_VISIBILITY_PRIVATE     = 2,
    _GPF_VISIBILITY_STATIC      = 3;

_GpfClassDefinition.prototype = {

    constructor: _GpfClassDefinition,

    // Unique identifier
    _uid: 0,

    // Full class name
    _name: &quot;&quot;,

    // Super class
    _Super: Object,

    // @property {Function[]} Child classes
    _Subs: [],

    // @property {Object|null} Dictionary of attributes to define (null if none)
    _definitionAttributes: null,

    // Class constructor (as it is exposed)
    _Constructor: _gpfEmptyFunc,

    // Class constructor according to the definition
    _definitionConstructor: null,

    // Resolved constructor (_definitionConstructor or _Super)
    _resolvedConstructor: _gpfEmptyFunc,

    // @property {Object} Class definition (as provided to define)
    _definition: null,

    // Prevent construction when doing inheritance
    isConstructionAllowed: function () {
        return _gpfClassConstructorAllowed;
    },

    /**
     * Adds a member to the class definition.
     *
     * @param {String} member
     * @param {*} memberValue
     * @param {String|number} [visibility=_GPF_VISIBILITY_PUBLIC] visibility
     */
    addMember: function (member, memberValue, visibility) {
        if (undefined === visibility) {
            visibility = _GPF_VISIBILITY_PUBLIC;
        } else {
            visibility = _gpfVisibilityKeywords.indexOf(visibility);
            if (-1 === visibility) {
                throw gpf.Error.classInvalidVisibility();
            }
        }
        this._addMember(member, memberValue, visibility);
    },

    /**
     * Adds a member to the class definition
     *
     * @param {String} member
     * @param {*} memberValue
     * @param {number} visibility
     */
    _addMember: function (member, memberValue, visibility) {
        if (_GPF_VISIBILITY_STATIC === visibility) {
            _gpfAssert(undefined === this._Constructor[member], &quot;Static members can&#039;t be overridden&quot;);
            /*gpf:constant*/ this._Constructor[member] = memberValue;
        } else if (&quot;constructor&quot; === member) {
            this._addConstructor(memberValue, visibility);
        } else {
            this._addNonStaticMember(member, memberValue, visibility);
        }
    },

    /**
     * Adds a constructor the class definition
     *
     * @param {*} memberValue Must be a function
     * @param {number} visibility
     * @closure
     */
    _addConstructor: function (memberValue, visibility) {
        _gpfAsserts({
            &quot;Constructor must be a function&quot;: &quot;function&quot; === typeof memberValue,
            &quot;Own constructor can&#039;t be overridden&quot;: null === this._definitionConstructor
        });
        if (_gpfUsesSuper(memberValue)) {
            memberValue = _gpfGenSuperMember(this._Super, memberValue);
        }
        _gpfIgnore(visibility); // TODO Handle constructor visibility
        this._definitionConstructor = memberValue;
    },

    /**
     * Defines a new non-static member of the class
     *
     * @param {String} member Name of the member to define
     * @param {*} memberValue
     * @param {Number} visibility Visibility of the members
     * @closure
     */
    _addNonStaticMember: function (member, memberValue, visibility) {
        var newType = typeof memberValue,
            baseMemberValue,
            baseType,
            prototype = this._Constructor.prototype;
        _gpfAssert(!prototype.hasOwnProperty(member), &quot;Existing own member can&#039;t be overridden&quot;);
        baseMemberValue = this._Super.prototype[member];
        baseType = typeof baseMemberValue;
        if (&quot;undefined&quot; !== baseType) {
            if (null !== baseMemberValue &amp;&amp; newType !== baseType) {
                throw gpf.Error.classMemberOverloadWithTypeChange();
            }
            if (&quot;function&quot; === newType &amp;&amp; _gpfUsesSuper(memberValue)) {
                memberValue = _gpfGenSuperMember(baseMemberValue, memberValue);
            }
        }
        _gpfIgnore(visibility); // TODO Handle constructor visibility
        prototype[member] = memberValue;
    },

    /**
     * Check if the current member is an attribute declaration.
     * If so, stores it into a temporary map that will be processed as the last step.
     *
     * @param {String} member
     * @param {*} memberValue
     * @returns {Boolean} True when an attribute is detected
     */
    _filterAttribute: function (member, memberValue) {
        var attributeArray;
        if (&quot;[&quot; !== member.charAt(0) || &quot;]&quot; !== member.charAt(member.length - 1)) {
            return false;
        }
        member = _gpfEncodeAttributeMember(member.substr(1, member.length - 2)); // Extract &amp; encode member name
        if (this._definitionAttributes) {
            attributeArray = this._definitionAttributes[member];
        } else {
            this._definitionAttributes = {};
        }
        if (undefined === attributeArray) {
            attributeArray = [];
        }
        this._definitionAttributes[member] = attributeArray.concat(memberValue);
        return true;
    },

    // Default member visibility
    _defaultVisibility: _GPF_VISIBILITY_UNKNOWN,

    // Compute member visibility from default visibility &amp; member name
    _deduceVisibility: function (memberName) {
        var visibility = this._defaultVisibility;
        if (_GPF_VISIBILITY_UNKNOWN === visibility) {
            if (memberName.charAt(0) === &quot;_&quot;) {
                visibility = _GPF_VISIBILITY_PROTECTED;
            } else {
                visibility = _GPF_VISIBILITY_PUBLIC;
            }
        }
        return visibility;
    },

    /**
     * Process definition member.
     * The member may be a visibility keyword, in that case _processDefinition is called recursively
     *
     * @param {*} memberValue
     * @param {string} memberName
     */
    _processDefinitionMember: function (memberValue, memberName) {
        if (this._filterAttribute(memberName, memberValue)) {
            return;
        }
        var newVisibility = _gpfVisibilityKeywords.indexOf(memberName);
        if (_GPF_VISIBILITY_UNKNOWN === newVisibility) {
            return this._addMember(memberName, memberValue, this._deduceVisibility(memberName));
        }
        if (_GPF_VISIBILITY_UNKNOWN !== this._defaultVisibility) {
            throw gpf.Error.classInvalidVisibility();
        }
        this._processDefinition(memberValue, newVisibility);
    },

    /**
     * Process class definition
     *
     * @param {Object} definition
     * @param {Number} visibility
     */
    _processDefinition: function (definition, visibility) {
        this._defaultVisibility = visibility;
        _gpfObjectForEach(definition, this._processDefinitionMember, this); /*gpf:inline(object)*/
        this._defaultVisibility = _GPF_VISIBILITY_UNKNOWN;
        /* istanbul ignore next */ // WSCRIPT specific
        // 2014-05-05 #14
        if (_GPF_HOST_WSCRIPT === _gpfHost &amp;&amp; definition.constructor !== Object) {
            this._addConstructor(definition.constructor, this._defaultVisibility);
        }
    },

    /**
     * Process the attributes collected in the definition
     *
     * NOTE: gpf.attributes._add is defined in attributes.js
     */
    _processAttributes: function () {
        var
            attributes = this._definitionAttributes,
            Constructor,
            newPrototype;
        if (attributes) {
            _gpfAssert(&quot;function&quot; === typeof _gpfAttributesAdd, &quot;Attributes can&#039;t be defined before they exist&quot;);
            Constructor = this._Constructor;
            newPrototype = Constructor.prototype;
            _gpfObjectForEach(attributes, function (attributeList, attributeName) {/*gpf:inline(object)*/
                attributeName = _gpfDecodeAttributeMember(attributeName);
                if (attributeName in newPrototype || attributeName === &quot;Class&quot;) {
                    _gpfAttributesAdd(Constructor, attributeName, attributeList);
                } else {
                    // 2013-12-15 ABZ Exceptional, trace it only
                    console.error(&quot;gpf.define: Invalid attribute name &#039;&quot; + attributeName + &quot;&#039;&quot;);
                }
            });
        }
    },

    // Build a new constructor
    _getNewClassConstructor: function (name) {
        var builder = new _GpfFunctionBuilder(_gpfNewClassConstructorTpl);
        builder.replaceInBody({
            &quot;function&quot;: &quot;function &quot; + name
        });
        return builder.generate()(this);
    },

    // Wraps super constructor within critical section to prevents class initialization (and unexpected side effects)
    _safeNewSuper: function () {
        var result;
        _gpfClassConstructorAllowed = false;
        result = new this._Super();
        _gpfClassConstructorAllowed = true;
        return result;
    },

    // Create the new Class constructor
    _build: function () {
        var
            newClass,
            newPrototype,
            baseClassDef,
            constructorName;

        // Build the function name for the constructor
        constructorName = this._name.split(&quot;.&quot;).pop();

        // The new class constructor
        newClass = this._getNewClassConstructor(constructorName);
        /*gpf:constant*/ this._Constructor = newClass;
        /*gpf:constant*/ newClass[_GPF_CLASSDEF_MARKER] = this._uid;

        // Basic JavaScript inheritance mechanism: Defines the newClass prototype as an instance of the super class
        newPrototype = this._safeNewSuper();

        // Populate our constructed prototype object
        newClass.prototype = newPrototype;

        // Enforce the constructor to be what we expect
        newPrototype.constructor = newClass;

        /*
         * Defines the link between this class and its base one
         * (It is necessary to do it here because of the gpf.addAttributes that will test the parent class)
         */
        baseClassDef = _gpfGetClassDefinition(this._Super);
        baseClassDef._Subs.push(newClass);

        /*
         * 2014-04-28 ABZ Changed again from two passes on all members to two passes in which the first one also
         * collects attributes to simplify the second pass.
         */
        this._processDefinition(this._definition, _GPF_VISIBILITY_UNKNOWN);
        this._processAttributes();

        // Optimization for the constructor
        this._resolveConstructor();
    },

    _resolveConstructor: function () {
        if (this._definitionConstructor) {
            this._resolvedConstructor = this._definitionConstructor;
        } else if (Object !== this._Super) {
            this._resolvedConstructor = this._Super;
        }
    }

};

//endregion

//region define

/**
 * Defines a new class by setting a contextual name
 *
 * @param {String} name New class contextual name
 * @param {String} base Base class contextual name
 * @param {Object} definition Class definition
 * @return {Function}
 */
function _gpfDefineCore (name, base, definition) {
    _gpfAsserts({
        &quot;name is required (String)&quot;: &quot;string&quot; === typeof name,
        &quot;base is required (String|Function)&quot;: &quot;string&quot; === typeof base || base instanceof Function,
        &quot;definition is required (Object)&quot;: &quot;object&quot; === typeof definition
    });
    var
        result,
        path,
        ns,
        leafName,
        classDef;
    if (-1 &lt; name.indexOf(&quot;.&quot;)) {
        path = name.split(&quot;.&quot;);
        leafName = path.pop();
        ns = _gpfContext(path, true);
    }
    if (&quot;string&quot; === typeof base) {
        // Convert base into the function
        base = _gpfContext(base.split(&quot;.&quot;));
        _gpfAssert(base instanceof Function, &quot;base must resolve to a function&quot;);
    }
    classDef = new _GpfClassDefinition(name, base, definition);
    result = classDef._Constructor;
    if (undefined !== ns) {
        ns[leafName] = result;
    }
    return result;
}

// Replace the shortcut with the correct property name
function _gpfCleanDefinition (name, shortcut) {
    /*jshint validthis:true*/ // Bound to the definition below
    var shortcutValue = this[shortcut];
    if (undefined !== shortcutValue) {
        this[name] = shortcutValue;
        delete this[shortcut];
    }
}

var _gpfCleaningShortcuts = {
    &quot;-&quot;: &quot;private&quot;,
    &quot;#&quot;: &quot;protected&quot;,
    &quot;+&quot;: &quot;public&quot;,
    &quot;~&quot;: &quot;static&quot;
};

/**
 * @inheritdoc _gpfDefineCore
 * Provides shortcuts for visibility:
 * - &quot;-&quot; for private
 * - &quot;#&quot; for protected
 * - &quot;+&quot; for public
 * - &quot;~&quot; for static
 */
function _gpfDefine (name, base, definition) {
    _gpfObjectForEach(_gpfCleaningShortcuts, _gpfCleanDefinition, definition);
    return _gpfDefineCore(name, base, definition);
}

/**
 * Defines a new class by setting a contextual name
 *
 * @param {String} name New class contextual name
 * @param {String} [base=undefined] base Base class contextual name
 * @param {Object} [definition=undefined] definition Class definition
 * @return {Function}
 */
gpf.define = function (name, base, definition) {
    if (&quot;object&quot; === typeof base) {
        definition = base;
        base = undefined;
    }
    if (undefined === base) {
        base = Object; // Root class
    }
    return _gpfDefineCore(name, base, definition || {});
};

/**
 * Allocate a new class handler that is specific to a class type (used for interfaces &amp; attributes)
 *
 * @param {String} ctxRoot Default context root (for intance: gpf.interfaces)
 * @param {String} defaultBase Default contextual root class (for instance: Interface)
 * @return {Function}
 * @closure
 */
function _gpfGenDefHandler (ctxRoot, defaultBase) {
    ctxRoot += &quot;.&quot;;
    defaultBase = ctxRoot + defaultBase;
    return function (name, base, definition) {
        if (undefined === definition &amp;&amp; &quot;object&quot; === typeof base) {
            definition = base;
            base = defaultBase;
        }
        if (-1 === name.indexOf(&quot;.&quot;)) {
            name = ctxRoot + name;
        }
        return _gpfDefine(name, base || defaultBase, definition || {});
    };
}

//endregion

/*#ifndef(UMD)*/

gpf.internals._gpfGetClassDefinition = _gpfGetClassDefinition;

/*#endif*/</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
