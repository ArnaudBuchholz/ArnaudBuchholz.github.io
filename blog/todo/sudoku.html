<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <title>SUDOKU Solver</title>
        <style type="text/css">

body {
    font-size: 10pt;
    font-family: Verdana, Courrier, Sans Serif;
    background-color: white;
    color: black;
}

#grid {
    border: 0;
}

#grid td {
    width: 32px;
    height: 32px;
    vertical-align: middle;
    text-align: center;
}

#grid td {
    background-color: #FFFFFF;
    position: relative;
}

#grid td.shaded {
    background-color: #EEEEEE;
}

#grid td span.resolved {
    font-style: italic;
}

#grid td span.resolved.new {
    color: rgb(0, 0, 255);
    font-style: italic;
}

#grid td.control {
    border: 0;
    cursor: hand;
    font-weight: bold;
    font-size: 18pt;
}

#grid td.null {
    border: 0;
}

#grid td.highlight {
    background-color: rgba(0, 0, 255, .2);
}

div.mark {
    position: absolute;
    width: 6px;
    height: 6px;
    background-color: rgba(0, 0, 255, .2);
}

td#preview div.mark {
    background-color: blue;
}

div.mark.off {
    display: none;
}

div.mark.digit1 {
    top: 2px;
}

div.mark.digit2 {
    top: 2px;
    left: 14px;
}

div.mark.digit3 {
    top: 2px;
    left: 26px;
}

div.mark.digit4 {
    top: 14px;
}

div.mark.digit5 {
    top: 14px;
    left: 14px;
}

div.mark.digit6 {
    top: 14px;
    left: 26px;
}

div.mark.digit7 {
    top: 26px;
}

div.mark.digit8 {
    top: 26px;
    left: 14px;
}

div.mark.digit9 {
    top: 26px;
    left: 26px;
}

div#status {
    border: solid #AAAAAA 1px;
    padding: 2px;
    margin: 2px;
}

        </style>
        <script language="javascript">

const
    // Helpers
    toXY = id => {
        let x = id % 9;
        return {
            x: x,
            y: (id - x) / 9
        };
    }
    toSquareId = id => {
        let {x, y} = toXY(id);
        return Math.floor(x / 3) + 3 * Math.floor(y / 3);
    },
    select = (selector, base = document) => [].slice.call(base.querySelectorAll(selector) || []),
    setStatus = text => document.getElementById("status").innerHTML = text || "",

    // State
    rows = [],
    cols = [],
    squares = [],
    digits = [],

    reset = () => {
        select(".cell").forEach(cell =>  cell.innerHTML = "&nbsp;");
        rows.length = 0;
        cols.length = 0;
        squares.length = 0;
        digits.length = 0;
        for (let index = 0; index < 9; ++index) {
            rows.push(0);
            cols.push(0);
            squares.push(0);
        }
        setStatus();
    },

    showRemainingDigits = (id, bits) => {
        let cell = document.getElementById(id);
        select("div.mark", cell).forEach(mark => mark.className = mark.className.replace(" off", ""));
        for (let bit = 1, digit = 1; digit < 10; bit <<= 1, ++digit) {
            if (bits & bit) {
                select("div.mark.digit" + digit, cell).forEach(mark => mark.className += " off");
            }
        }
    }

    set = (id, digit, className) => {
        let {x, y} = toXY(id),
            bit = 2**(digit - 1),
            squareId = toSquareId(id),
            row = rows[y] |= bit,
            col = cols[x] |= bit,
            sqr = squares[squareId] |= bit,
            cell;
        digits[id] = digit;
        showRemainingDigits("row" + y, row);
        showRemainingDigits("col" + x, col);
        showRemainingDigits("square" + squareId, sqr);
        cell = document.getElementById(id);
        if (className) {
            span = document.createElement("span");
            span.className = className;
            cell = cell.appendChild(span);
        }
        cell.innerHTML = digit;
    },

    load = () => {
        const samples = document.getElementById("samples"),
              data = samples.options[samples.selectedIndex].value;
        reset();
        data.split("").forEach((digit, index) => digit !== "." ? set(index, digit) : 0);
    }

    searchForDigits = () => {
        let
            found = 0,
            rowDigits = [[], [], [], [], [], [], [], [], []],
            colDigits = [[], [], [], [], [], [], [], [], []],
            squareDigits = [[], [], [], [], [], [], [], [], []];

        const
            isSet = id => undefined !== digits[id],

            addCandidate = (candidates, digit, id) => {
                if (undefined === candidates[digit]) {
                    candidates[digit] = id; // First candidate
                } else {
                    candidates[digit] = null; // Too many candidates
                }
            },

            solve = (id, digit) => {
                ++found;
                set(id, digit, "resolved new");
            }

            checkCandidates = arrayOfCandidates => {
                arrayOfCandidates.forEach(candidates => candidates.forEach((id, digit) => {
                    if ("number" === typeof id && !isSet(id)) {
                        solve(id, digit);
                    }
                }));
            };

        select(".new").forEach(cell => cell.className = cell.className.replace(" new", ""));

        for (let id = 0; id < 81; ++id) {
            if (isSet(id)) {
                continue;
            }
            let
                {x, y} = toXY(id),
                squareId = toSquareId(id),
                bits = rows[y] | cols[x] | squares[squareId],
                digit;
            [
                0b111111110,
                0b111111101,
                0b111111011,
                0b111110111,
                0b111101111,
                0b111011111,
                0b110111111,
                0b101111111,
                0b011111111,
            ].forEach((digitZeroBit, index) => {
                // If only one choice possible
                if (bits === digitZeroBit) {
                    digit = index + 1;
                } else  if ((bits & digitZeroBit) === bits) {
                    addCandidate(rowDigits[y], index + 1, id);
                    addCandidate(colDigits[x], index + 1, id);
                    addCandidate(squareDigits[squareId], index + 1, id);
                }
            });
            if (digit) {
                solve(id, digit);
            }
        }
        if (!found) {
            checkCandidates(rowDigits);
            checkCandidates(colDigits);
            checkCandidates(squareDigits);
        }
        return found;
    },

    // Solve
    solve = oneStep => {
        let count = 0,
            totalFound = 0,
            found = 0;
        do {
            totalFound += found;
            ++count;
        } while ((found = searchForDigits()) && !oneStep);
        totalFound += found;
        setStatus("Iterations: " + count + " - Found: " + totalFound);
    };

window.addEventListener("load", () => {
    const
        grid = document.getElementById("grid"),
        marks = cell => {
            for (let digit = 1; digit < 10; ++digit) {
                let div = document.createElement("div");
                div.className = "mark digit" + digit;
                cell.appendChild(div);
            }
        };
    for (let y = -1; y < 9; ++y) {
        let tr = grid.appendChild(document.createElement("tr"));
        for (let x = -1; x < 10; ++x) {
            let td = tr.appendChild(document.createElement("td"));
            if (-1 === y) {
                if (-1 === x || 9 === x) {
                    td.className += " null";
                    td.innerHTML = "&nbsp;";
                    if (x * y !== 1) {
                        continue;
                    } else {
                        td.id = "preview";
                    }
                } else {
                    td.className += " control";
                    td.innerHTML = "&darr;";
                    td.id = "col" + x;
                    td.setAttribute("down", x);
                }
            } else if (-1 === x) {
                td.className += " control";
                td.innerHTML = "&rarr;";
                td.id = "row" + y;
                td.setAttribute("right", y);

            } else if (9 === x) {
                td.className += " control";
                td.innerHTML = "&square;";
                td.id = "square" + y;
                td.setAttribute("square", y);

            } else {
                let id = y * 9 + x,
                    squareId = toSquareId(id);
                td.id = id;
                td.title = id;
                td.className = "cell row" + y + " col" + x + " square" + squareId;
                td.innerHTML = "&nbsp;";
                if (squareId % 2 === 0) {
                    td.className += " shaded";
                }
            }
            marks(td);
        }
    }
    grid.addEventListener("mouseover", event => {
        select(".highlight").forEach(cell => {
            cell.className = cell.className.replace(/\bhighlight\b/, () => "").trim();
        });
        const
            target = event.target,
            test = (name, classPrefix) => {
                let value = target.getAttribute(name);
                if (value) {
                    return `.${classPrefix || name}${value}`;
                }
            },
            classToHighlight = test("down", "col") || test("right", "row") || test("square");
        if (classToHighlight) {
            select(classToHighlight).concat(target).forEach(cell => cell.className += " highlight");
        } else if (target.className.includes("cell")) {
            let id = parseInt(target.id, 10),
                {x, y} = toXY(id),
                bits = rows[y] | cols[x] | squares[toSquareId(id)];
            showRemainingDigits("preview", bits);
        }

    });
    document.getElementById("solve").addEventListener("click", solve.bind(null, false));
    document.getElementById("solve1").addEventListener("click", solve.bind(null, true));
    document.getElementById("samples").addEventListener("change", load);
    load();
});

        </script>
    </head>
    <body>
        <select id="samples">
            <option value="4........8....1276...72..38.6....1..29.1.4.87..1....5.51..82...9274....1........5">Sample 1 (medium)</option>
            <option value=".5.8..4..7..9.3.....87...1...2.5.....6...73.4..9...62.1..4.9.....4...2..29..7...8">Sample 2 (metro.ca 2017-04-07 )</option>
        </select>
        <input type="button" id="solve" value="Solve"">
        <input type="button" id="solve1" value="One step"">
        <table id="grid" border="1"></table>
        <div id="status"></div>
    </body>
</html>
